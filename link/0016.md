# 应用层之Telent
* 阅读难度：低

## 聊一聊 - 远程控制底层到底是怎样实现的？
* 相信读者们肯定用过很多远程控制软件，诸如TeamViewer等。但是，我们有没有认真的想过他们的底层是通过怎么样的方式进行通信的呢?本节我会向大家介绍用于实现终端上的远程控制的协议——Telent协议，希望大家有所启发。

## Telnet协议
* 部分术语解释
	* NVT:Net Virtual Terminal，由Telnet协议定义的，一种数据和命令在Internet上的传输方式
		* 对于发送的数据：客户端把本地的终端控键转换为NVT格式，发送到服务器。服务端将收到的NVT格式数据，从NVT格式转换为服务端系统需要的数据和命令格式
		* 对于返回的数据：服务端将服务端处的数据和命令转换为NVT格式。客户端将接收到的NVT格式数据再转换为本地的格式
	* NVTASCII:代表7比特的ASCII字符集，网间网协议族都使用NVTASCII。每个7比特的字符都以8比特格式发送，最高位比特为0，并且行结束符以/r/n来表示,单独的回车以/r/0表示
	* IAC:Interpret As Command，当客户端/服务端发送的命令并非数据流而是命令序列时，它就在数据流中插入一个特殊的保留字符，这个特殊字符便是IAC。当接收方在一个数据流中发现IAC字符时，它就把后继的字节处理成一个命令序列
	
---
## Telent协议的特点
* 适应异构:为适应多个操作系统，使用NVT格式进行传输
* 传输远地命令:将正常的ASCII字符与控制命令区分，并以NVT格式传输
	* 这种区分使得Telent协议具有更大的灵活性，以及使得客户端可以正确地输入指令/使用快捷键，而不会使得快捷键的控制功能与普通的输入字符混淆
* 数据流向:每一次的输入输出，因为需要经过NVT格式转换，所以客户端都需要将进程环境切换好几次(客户端输入，客户端打包NVT,客户端发送，服务端接收，服务端解包NVT，返回服务端终端)，因此若Telent协议设计为应用软件，则会导致效率不高的问题出现
* 强制命令:强制指令是指，当客户端误向服务端发送错误的指令导致死循环后，Telent协议可使用紧急指令（由Telent的数据标记字节 + TCP设置并发送紧急数据的报文段通知服务端），强制服务端抛弃无用数据，以让服务端恢复正常，而非让无用数据把TCP连接的缓冲区挤满导致客户端“掉线”。
* 选项协商:为了Telent协议的适应异构性，我们必须把客户端和服务端的"冲突选项"去掉。通信的任何一端都可以发出协商选项的申请，任何一端都可以接受或拒绝这个申请。
	* eg:我客户端上面有一个选项A，你服务端上面有一个选项B，刚好这两个选项是冲突的，因此，我们必须先坐下来协商怎么弄，是用你的还是用我的，还是大家都不用。
	
	![telent-1](https://github.com/SeaHub/BlogOfComputerNetwork/blob/master/res/telent1.gif?raw=true)
		
---
## 使用Telent协议进行远程控制的条件
* 在客户机中装有包含Telent协议的客户端
* 知道服务器的IP地址/域名
* 知道服务器的用户名 && 密码

---
## Telent协议工作流程
* 客户端与服务端建立TCP连接
* 客户端向服务端发送一个IP包
	* 该IP包包含以NVT格式封装的用户名及密码，用于验证用户
* 客户端与服务端开始传输数据。传输的数据主要为由客户端以NVT格式封装的NVTASCII与控制指令，以及由服务端以NVT格式封装的命令回显与命令执行结果
* 传输完成后，客户端对服务端提出，关闭TCP连接，连接中止

	![telent-2](https://github.com/SeaHub/BlogOfComputerNetwork/blob/master/res/telent2.jpg?raw=true)
	
---
## Telent的缺点
* Telent传输的数据没有加密，可能导致账号、密码等数据被窃听，因此相对于Telent，很多服务器会选择更安全的SSH

---
## 参考阅读
* [Telent协议详解](http://www.cnblogs.com/dazhaxie/archive/2012/06/27/2566054.html)
* [应用层协议与应用telnet](http://v.youku.com/v_show/id_XNTQwMDU5OTI=.html)

---
* 文章更新时间：2016.6.16
* 作者：Seahub
