# 应用层之DNS
* 阅读难度：低

## 聊一聊 - 为什么要有DNS
* 很久之前，在没有DNS的时代，人们上网都是通过IP地址对网站进行访问。这是一个什么样的概念呢，这就像是我们打电话一样。我们想要访问维基百科，只能通过诸如208.80.154.225之类的IP地址访问，就像我们打电话给一个人，只能通过他的电话号码打过去。但是这样的地址实在不方便书写与记忆，所以人们就发明了DNS，它能够用简单的名称访问网站，而非书写难以记忆以及书写的IP地址。在某种程度上，域名可以理解成我们的短号，以后你再需要打这个人的电话（访问网站）时，只需要输入他容易记忆的短号（域名），而非输入难以记忆的长号（IP地址）

## DNS（Domain Name System）- 域名系统
* 部分术语解释
	* DNS:一种组织成域层次结构的计算机和网络服务命名系统，用于TCP/IP网咯，将主机名和域名转换成IP地址
	* 域命名空间：DNS数据库中的名称形成的一个分层树状结构
	* 根域：DNS域名使用时，规定由尾部句号(.)来指定名称位于根或更高级别的层次结构。根域服务器只有13个IP地址，这13个IP地址永远不变，一般写在配置文件中（eg: "."）
	* 顶级域：用来指定某个国家/地区/组织使用的类型名称 (eg: .org)
	* 第二层域: 个人/组织在Internet上使用的注册名称 (eg: wikipedia.org)
	* 子域: 二级域名及二级域名派生的域名 （eg: www.wikipedia.org）
	* 主机名: 一般而言，DNS域名最左侧的标签标识网络上特定的主机,如host (eg:host.www.wikipedia.org)
	* 就地应答：客户机使用以前查询获得的缓存信息来获取IP地址
	* 递归：DNS服务器代表客户机来请求其他DNS服务器，以完全解析该域名，解析后将应答逐层返回(eg: 客户机 -> 本地DNS)
	* 迭代：客户机自己使用基于服务器应答的独立和附加查询，尝试联系其他DNS服务器解析域名（eg: DNS服务器 <-> DNS服务器）
	* 权威服务器：每个域的域名服务器，直接提供DNS查询服务，不做递归的DNS服务器
	* ISP:Internet Service Provider，互联网服务提供商.ISP向广大用户综合提供互联网接入业务的电信运营商
	* TTL: Time To Live（生存时间），表示DNS记录在DNS服务器上缓存的时间
	
---
## A、NS、MX、CNAME记录简介
* A记录: 主机IP地址记录，目标地址只能使用IP地址
	* 泛域名解析：将该域名所有未指定的子域名指向一个空间，A记录主机名中填入*，IP地址指向空间IP地址即可
	* 负载均衡：需要虚拟主机服务商支持，表示一个子域名有多个目标地址，当用户访问这个域名时，IP地址循环，即将用户的流量分散至不同的主机
* NS记录: 解析服务器记录，表明由哪台服务器对该域名进行解析，NS记录只对子域名生效
	* 同样有优先级，数字越小级别越高
	* NS记录优先于A记录，如果一个主机地址同时存在NS记录和A记录，则A记录不生效
* MX记录:邮件交换记录，用于将以该域名结尾的电子邮件指向对应的邮件服务器，目标地址可以使用主机名/IP地址
	* MX记录可以通过设置优先级实现主辅服务器设置（优先级越小级别越高），也可以使用相同优先级达到负载均衡的目的，同样，负载均衡也要需要邮件服务商支持
* CNAME记录：别名指向记录，为一个主机设置别名，目标主机地址只能使用主机名而非IP地址
	* A记录优先于CNAME记录，如果一个主机地址同时存在A记录和CNAME记录，则CNAME记录不生效
	
--- 
## DNS工作流程
1. 客户机 -> 接入互联网 -> ISP分配一个DNS服务器给客户机(客户机亦可手动设置DNS服务器)
2. 客户机 -> 请求www.wikipedia.org -> 本地DNS
3. 本地DNS -> 检查缓存是否有地址记录
	* 有：返回IP地址，该IP地址被标记为非权威服务器应答
	* 无: 下一步
4. 本地DNS -> 从配置文件获取13个不变的根域名服务器地址 -> 向其中一台发起请求
5. 根服务器 -> 返回.org的NS记录 -> 返回一系列的主机名和IP
6. 本地DNS -> 向这一系列的其中一台发起请求 -> .org域服务器
7. .org域服务器 -> 返回wikipedia.org的NS记录 -> 返回一系列的主机名和IP
8. 本地DNS -> 向这一系列的其中一台发起请求 -> .wikipedia.org域服务器
9. .wikipedia.org域服务器 -> 返回www.wikipedia.org的A记录，即返回IP地址
	* 此IP地址被标记为权威服务器应答
10. 本地DNS -> 获取IP地址 -> 保存在缓存中 -> 返回给客户机

	
	![DNS-1](https://github.com/SeaHub/BlogOfComputerNetwork/blob/master/res/DNS2.png?raw=true)
    ![DNS-2](https://github.com/SeaHub/BlogOfComputerNetwork/blob/master/res/DNS1.png?raw=true)
    
## 续聊 - 权威服务器为什么权威？
* 由上文我们可以知道，本地DNS一般会缓存许多域名的DNS记录，以加快用户访问的网站速度。我们知道本地DNS主要是ISP DNS服务器。一般ISP DNS服务器更新频率为1 - 2天。这就导致了一个问题出现：别人不用的老域名，我租用了并重新解析到另外一个IP地址，可能需要等很长时间才能正常解析。这是因为在ISP DNS服务器中的数据没有更新导致的。存放在ISP DNS服务器的DNS记录由于没有更新，用户获得的IP地址其实是从ISP DNS服务器缓存中获取的，这就导致了其实获得的IP地址实际上是过期的，我们必须等待下一次ISP DNS服务器缓存更新才能正常的将域名解析到我们的新的IP地址中。而假若我们租用的是一个新域名，解析反而会快一点，这是因为所有的ISP DNS服务器都没有缓存，大家都需要请求权威服务器，查询域名数据库，获得IP地址。而非像前者一样直接从缓存中获取。
* 因此，我认为，权威服务器之所以权威，是因为它保证了域名与IP地址的即时性。只要你问它这个域名代表的IP地址是什么，它告诉你的永远都会是最正确的。相比之下，其他带有缓存的DNS服务器告诉你的，可能已经是“过去式”了。

---
## 参考阅读
1. [YouTube - DNS Explained](https://www.youtube.com/watch?v=72snZctFFtA)
2. [王达 - 例解DNS递归/迭代名称解析原理](http://blog.csdn.net/lycb_gz/article/details/11720247)

---
* 文章更新时间：2016.5.26
* 作者：Seahub
